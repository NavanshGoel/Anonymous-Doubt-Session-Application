{"ast":null,"code":"\"use strict\";\n\nconst webIDLConversions = require(\"webidl-conversions\");\n\nconst DOMException = require(\"domexception/webidl2js-wrapper\");\n\nconst NODE_TYPE = require(\"../node-type\");\n\nconst {\n  HTML_NS\n} = require(\"../helpers/namespaces\");\n\nconst {\n  getHTMLElementInterface\n} = require(\"../helpers/create-element\");\n\nconst {\n  shadowIncludingInclusiveDescendantsIterator\n} = require(\"../helpers/shadow-dom\");\n\nconst {\n  isValidCustomElementName,\n  tryUpgradeElement,\n  enqueueCEUpgradeReaction\n} = require(\"../helpers/custom-elements\");\n\nconst idlUtils = require(\"../generated/utils\");\n\nconst IDLFunction = require(\"../generated/Function.js\");\n\nconst HTMLUnknownElement = require(\"../generated/HTMLUnknownElement\");\n\nconst LIFECYCLE_CALLBACKS = [\"connectedCallback\", \"disconnectedCallback\", \"adoptedCallback\", \"attributeChangedCallback\"];\n\nfunction convertToSequenceDOMString(obj) {\n  if (!obj || !obj[Symbol.iterator]) {\n    throw new TypeError(\"Invalid Sequence\");\n  }\n\n  return Array.from(obj).map(webIDLConversions.DOMString);\n} // Returns true is the passed value is a valid constructor.\n// Borrowed from: https://stackoverflow.com/a/39336206/3832710\n\n\nfunction isConstructor(value) {\n  if (typeof value !== \"function\") {\n    return false;\n  }\n\n  try {\n    const P = new Proxy(value, {\n      construct() {\n        return {};\n      }\n\n    }); // eslint-disable-next-line no-new\n\n    new P();\n    return true;\n  } catch {\n    return false;\n  }\n} // https://html.spec.whatwg.org/#customelementregistry\n\n\nclass CustomElementRegistryImpl {\n  constructor(globalObject) {\n    this._customElementDefinitions = [];\n    this._elementDefinitionIsRunning = false;\n    this._whenDefinedPromiseMap = Object.create(null);\n    this._globalObject = globalObject;\n  } // https://html.spec.whatwg.org/#dom-customelementregistry-define\n\n\n  define(name, constructor, options) {\n    const {\n      _globalObject\n    } = this;\n    const ctor = constructor.objectReference;\n\n    if (!isConstructor(ctor)) {\n      throw new TypeError(\"Constructor argument is not a constructor.\");\n    }\n\n    if (!isValidCustomElementName(name)) {\n      throw DOMException.create(_globalObject, [\"Name argument is not a valid custom element name.\", \"SyntaxError\"]);\n    }\n\n    const nameAlreadyRegistered = this._customElementDefinitions.some(entry => entry.name === name);\n\n    if (nameAlreadyRegistered) {\n      throw DOMException.create(_globalObject, [\"This name has already been registered in the registry.\", \"NotSupportedError\"]);\n    }\n\n    const ctorAlreadyRegistered = this._customElementDefinitions.some(entry => entry.objectReference === ctor);\n\n    if (ctorAlreadyRegistered) {\n      throw DOMException.create(_globalObject, [\"This constructor has already been registered in the registry.\", \"NotSupportedError\"]);\n    }\n\n    let localName = name;\n    let extendsOption = null;\n\n    if (options !== undefined && options.extends) {\n      extendsOption = options.extends;\n    }\n\n    if (extendsOption !== null) {\n      if (isValidCustomElementName(extendsOption)) {\n        throw DOMException.create(_globalObject, [\"Option extends value can't be a valid custom element name.\", \"NotSupportedError\"]);\n      }\n\n      const extendsInterface = getHTMLElementInterface(extendsOption);\n\n      if (extendsInterface === HTMLUnknownElement) {\n        throw DOMException.create(_globalObject, [`${extendsOption} is an HTMLUnknownElement.`, \"NotSupportedError\"]);\n      }\n\n      localName = extendsOption;\n    }\n\n    if (this._elementDefinitionIsRunning) {\n      throw DOMException.create(_globalObject, [\"Invalid nested custom element definition.\", \"NotSupportedError\"]);\n    }\n\n    this._elementDefinitionIsRunning = true;\n    let disableShadow = false;\n    let observedAttributes = [];\n    const lifecycleCallbacks = {\n      connectedCallback: null,\n      disconnectedCallback: null,\n      adoptedCallback: null,\n      attributeChangedCallback: null\n    };\n    let caughtError;\n\n    try {\n      const {\n        prototype\n      } = ctor;\n\n      if (typeof prototype !== \"object\") {\n        throw new TypeError(\"Invalid constructor prototype.\");\n      }\n\n      for (const callbackName of LIFECYCLE_CALLBACKS) {\n        const callbackValue = prototype[callbackName];\n\n        if (callbackValue !== undefined) {\n          lifecycleCallbacks[callbackName] = IDLFunction.convert(callbackValue, {\n            context: `The lifecycle callback \"${callbackName}\"`\n          });\n        }\n      }\n\n      if (lifecycleCallbacks.attributeChangedCallback !== null) {\n        const observedAttributesIterable = ctor.observedAttributes;\n\n        if (observedAttributesIterable !== undefined) {\n          observedAttributes = convertToSequenceDOMString(observedAttributesIterable);\n        }\n      }\n\n      let disabledFeatures = [];\n      const disabledFeaturesIterable = ctor.disabledFeatures;\n\n      if (disabledFeaturesIterable) {\n        disabledFeatures = convertToSequenceDOMString(disabledFeaturesIterable);\n      }\n\n      disableShadow = disabledFeatures.includes(\"shadow\");\n    } catch (err) {\n      caughtError = err;\n    } finally {\n      this._elementDefinitionIsRunning = false;\n    }\n\n    if (caughtError !== undefined) {\n      throw caughtError;\n    }\n\n    const definition = {\n      name,\n      localName,\n      constructor,\n      objectReference: ctor,\n      observedAttributes,\n      lifecycleCallbacks,\n      disableShadow,\n      constructionStack: []\n    };\n\n    this._customElementDefinitions.push(definition);\n\n    const document = idlUtils.implForWrapper(this._globalObject._document);\n    const upgradeCandidates = [];\n\n    for (const candidate of shadowIncludingInclusiveDescendantsIterator(document)) {\n      if (candidate._namespaceURI === HTML_NS && candidate._localName === localName && (extendsOption === null || candidate._isValue === name)) {\n        upgradeCandidates.push(candidate);\n      }\n    }\n\n    for (const upgradeCandidate of upgradeCandidates) {\n      enqueueCEUpgradeReaction(upgradeCandidate, definition);\n    }\n\n    if (this._whenDefinedPromiseMap[name] !== undefined) {\n      this._whenDefinedPromiseMap[name].resolve(undefined);\n\n      delete this._whenDefinedPromiseMap[name];\n    }\n  } // https://html.spec.whatwg.org/#dom-customelementregistry-get\n\n\n  get(name) {\n    const definition = this._customElementDefinitions.find(entry => entry.name === name);\n\n    return definition && definition.objectReference;\n  } // https://html.spec.whatwg.org/#dom-customelementregistry-whendefined\n\n\n  whenDefined(name) {\n    if (!isValidCustomElementName(name)) {\n      return Promise.reject(DOMException.create(this._globalObject, [\"Name argument is not a valid custom element name.\", \"SyntaxError\"]));\n    }\n\n    const alreadyRegistered = this._customElementDefinitions.some(entry => entry.name === name);\n\n    if (alreadyRegistered) {\n      return Promise.resolve();\n    }\n\n    if (this._whenDefinedPromiseMap[name] === undefined) {\n      let resolve;\n      const promise = new Promise(r => {\n        resolve = r;\n      }); // Store the pending Promise along with the extracted resolve callback to actually resolve the returned Promise,\n      // once the custom element is registered.\n\n      this._whenDefinedPromiseMap[name] = {\n        promise,\n        resolve\n      };\n    }\n\n    return this._whenDefinedPromiseMap[name].promise;\n  } // https://html.spec.whatwg.org/#dom-customelementregistry-upgrade\n\n\n  upgrade(root) {\n    for (const candidate of shadowIncludingInclusiveDescendantsIterator(root)) {\n      if (candidate.nodeType === NODE_TYPE.ELEMENT_NODE) {\n        tryUpgradeElement(candidate);\n      }\n    }\n  }\n\n}\n\nmodule.exports = {\n  implementation: CustomElementRegistryImpl\n};","map":{"version":3,"sources":["/Users/kanavmittal/Downloads/Anonymous-Doubt-Session-Application-Ashank-App/node_modules/jsdom/lib/jsdom/living/custom-elements/CustomElementRegistry-impl.js"],"names":["webIDLConversions","require","DOMException","NODE_TYPE","HTML_NS","getHTMLElementInterface","shadowIncludingInclusiveDescendantsIterator","isValidCustomElementName","tryUpgradeElement","enqueueCEUpgradeReaction","idlUtils","IDLFunction","HTMLUnknownElement","LIFECYCLE_CALLBACKS","convertToSequenceDOMString","obj","Symbol","iterator","TypeError","Array","from","map","DOMString","isConstructor","value","P","Proxy","construct","CustomElementRegistryImpl","constructor","globalObject","_customElementDefinitions","_elementDefinitionIsRunning","_whenDefinedPromiseMap","Object","create","_globalObject","define","name","options","ctor","objectReference","nameAlreadyRegistered","some","entry","ctorAlreadyRegistered","localName","extendsOption","undefined","extends","extendsInterface","disableShadow","observedAttributes","lifecycleCallbacks","connectedCallback","disconnectedCallback","adoptedCallback","attributeChangedCallback","caughtError","prototype","callbackName","callbackValue","convert","context","observedAttributesIterable","disabledFeatures","disabledFeaturesIterable","includes","err","definition","constructionStack","push","document","implForWrapper","_document","upgradeCandidates","candidate","_namespaceURI","_localName","_isValue","upgradeCandidate","resolve","get","find","whenDefined","Promise","reject","alreadyRegistered","promise","r","upgrade","root","nodeType","ELEMENT_NODE","module","exports","implementation"],"mappings":"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","sourcesContent":["\"use strict\";\n\nconst webIDLConversions = require(\"webidl-conversions\");\nconst DOMException = require(\"domexception/webidl2js-wrapper\");\n\nconst NODE_TYPE = require(\"../node-type\");\n\nconst { HTML_NS } = require(\"../helpers/namespaces\");\nconst { getHTMLElementInterface } = require(\"../helpers/create-element\");\nconst { shadowIncludingInclusiveDescendantsIterator } = require(\"../helpers/shadow-dom\");\nconst { isValidCustomElementName, tryUpgradeElement, enqueueCEUpgradeReaction } = require(\"../helpers/custom-elements\");\n\nconst idlUtils = require(\"../generated/utils\");\nconst IDLFunction = require(\"../generated/Function.js\");\nconst HTMLUnknownElement = require(\"../generated/HTMLUnknownElement\");\n\nconst LIFECYCLE_CALLBACKS = [\n  \"connectedCallback\",\n  \"disconnectedCallback\",\n  \"adoptedCallback\",\n  \"attributeChangedCallback\"\n];\n\nfunction convertToSequenceDOMString(obj) {\n  if (!obj || !obj[Symbol.iterator]) {\n    throw new TypeError(\"Invalid Sequence\");\n  }\n\n  return Array.from(obj).map(webIDLConversions.DOMString);\n}\n\n// Returns true is the passed value is a valid constructor.\n// Borrowed from: https://stackoverflow.com/a/39336206/3832710\nfunction isConstructor(value) {\n  if (typeof value !== \"function\") {\n    return false;\n  }\n\n  try {\n    const P = new Proxy(value, {\n      construct() {\n        return {};\n      }\n    });\n\n    // eslint-disable-next-line no-new\n    new P();\n\n    return true;\n  } catch {\n    return false;\n  }\n}\n\n// https://html.spec.whatwg.org/#customelementregistry\nclass CustomElementRegistryImpl {\n  constructor(globalObject) {\n    this._customElementDefinitions = [];\n    this._elementDefinitionIsRunning = false;\n    this._whenDefinedPromiseMap = Object.create(null);\n\n    this._globalObject = globalObject;\n  }\n\n  // https://html.spec.whatwg.org/#dom-customelementregistry-define\n  define(name, constructor, options) {\n    const { _globalObject } = this;\n    const ctor = constructor.objectReference;\n\n    if (!isConstructor(ctor)) {\n      throw new TypeError(\"Constructor argument is not a constructor.\");\n    }\n\n    if (!isValidCustomElementName(name)) {\n      throw DOMException.create(_globalObject, [\"Name argument is not a valid custom element name.\", \"SyntaxError\"]);\n    }\n\n    const nameAlreadyRegistered = this._customElementDefinitions.some(entry => entry.name === name);\n    if (nameAlreadyRegistered) {\n      throw DOMException.create(_globalObject, [\n        \"This name has already been registered in the registry.\",\n        \"NotSupportedError\"\n      ]);\n    }\n\n    const ctorAlreadyRegistered = this._customElementDefinitions.some(entry => entry.objectReference === ctor);\n    if (ctorAlreadyRegistered) {\n      throw DOMException.create(_globalObject, [\n        \"This constructor has already been registered in the registry.\",\n        \"NotSupportedError\"\n      ]);\n    }\n\n    let localName = name;\n\n    let extendsOption = null;\n    if (options !== undefined && options.extends) {\n      extendsOption = options.extends;\n    }\n\n    if (extendsOption !== null) {\n      if (isValidCustomElementName(extendsOption)) {\n        throw DOMException.create(_globalObject, [\n          \"Option extends value can't be a valid custom element name.\",\n          \"NotSupportedError\"\n        ]);\n      }\n\n      const extendsInterface = getHTMLElementInterface(extendsOption);\n      if (extendsInterface === HTMLUnknownElement) {\n        throw DOMException.create(_globalObject, [\n          `${extendsOption} is an HTMLUnknownElement.`,\n          \"NotSupportedError\"\n        ]);\n      }\n\n      localName = extendsOption;\n    }\n\n    if (this._elementDefinitionIsRunning) {\n      throw DOMException.create(_globalObject, [\n        \"Invalid nested custom element definition.\",\n        \"NotSupportedError\"\n      ]);\n    }\n\n    this._elementDefinitionIsRunning = true;\n\n    let disableShadow = false;\n    let observedAttributes = [];\n    const lifecycleCallbacks = {\n      connectedCallback: null,\n      disconnectedCallback: null,\n      adoptedCallback: null,\n      attributeChangedCallback: null\n    };\n\n    let caughtError;\n    try {\n      const { prototype } = ctor;\n\n      if (typeof prototype !== \"object\") {\n        throw new TypeError(\"Invalid constructor prototype.\");\n      }\n\n      for (const callbackName of LIFECYCLE_CALLBACKS) {\n        const callbackValue = prototype[callbackName];\n\n        if (callbackValue !== undefined) {\n          lifecycleCallbacks[callbackName] = IDLFunction.convert(callbackValue, {\n            context: `The lifecycle callback \"${callbackName}\"`\n          });\n        }\n      }\n\n      if (lifecycleCallbacks.attributeChangedCallback !== null) {\n        const observedAttributesIterable = ctor.observedAttributes;\n\n        if (observedAttributesIterable !== undefined) {\n          observedAttributes = convertToSequenceDOMString(observedAttributesIterable);\n        }\n      }\n\n      let disabledFeatures = [];\n      const disabledFeaturesIterable = ctor.disabledFeatures;\n      if (disabledFeaturesIterable) {\n        disabledFeatures = convertToSequenceDOMString(disabledFeaturesIterable);\n      }\n\n      disableShadow = disabledFeatures.includes(\"shadow\");\n    } catch (err) {\n      caughtError = err;\n    } finally {\n      this._elementDefinitionIsRunning = false;\n    }\n\n    if (caughtError !== undefined) {\n      throw caughtError;\n    }\n\n    const definition = {\n      name,\n      localName,\n      constructor,\n      objectReference: ctor,\n      observedAttributes,\n      lifecycleCallbacks,\n      disableShadow,\n      constructionStack: []\n    };\n\n    this._customElementDefinitions.push(definition);\n\n    const document = idlUtils.implForWrapper(this._globalObject._document);\n\n    const upgradeCandidates = [];\n    for (const candidate of shadowIncludingInclusiveDescendantsIterator(document)) {\n      if (\n        (candidate._namespaceURI === HTML_NS && candidate._localName === localName) &&\n        (extendsOption === null || candidate._isValue === name)\n      ) {\n        upgradeCandidates.push(candidate);\n      }\n    }\n\n    for (const upgradeCandidate of upgradeCandidates) {\n      enqueueCEUpgradeReaction(upgradeCandidate, definition);\n    }\n\n    if (this._whenDefinedPromiseMap[name] !== undefined) {\n      this._whenDefinedPromiseMap[name].resolve(undefined);\n      delete this._whenDefinedPromiseMap[name];\n    }\n  }\n\n  // https://html.spec.whatwg.org/#dom-customelementregistry-get\n  get(name) {\n    const definition = this._customElementDefinitions.find(entry => entry.name === name);\n    return definition && definition.objectReference;\n  }\n\n  // https://html.spec.whatwg.org/#dom-customelementregistry-whendefined\n  whenDefined(name) {\n    if (!isValidCustomElementName(name)) {\n      return Promise.reject(DOMException.create(\n        this._globalObject,\n        [\"Name argument is not a valid custom element name.\", \"SyntaxError\"]\n      ));\n    }\n\n    const alreadyRegistered = this._customElementDefinitions.some(entry => entry.name === name);\n    if (alreadyRegistered) {\n      return Promise.resolve();\n    }\n\n    if (this._whenDefinedPromiseMap[name] === undefined) {\n      let resolve;\n      const promise = new Promise(r => {\n        resolve = r;\n      });\n\n      // Store the pending Promise along with the extracted resolve callback to actually resolve the returned Promise,\n      // once the custom element is registered.\n      this._whenDefinedPromiseMap[name] = {\n        promise,\n        resolve\n      };\n    }\n\n    return this._whenDefinedPromiseMap[name].promise;\n  }\n\n  // https://html.spec.whatwg.org/#dom-customelementregistry-upgrade\n  upgrade(root) {\n    for (const candidate of shadowIncludingInclusiveDescendantsIterator(root)) {\n      if (candidate.nodeType === NODE_TYPE.ELEMENT_NODE) {\n        tryUpgradeElement(candidate);\n      }\n    }\n  }\n}\n\nmodule.exports = {\n  implementation: CustomElementRegistryImpl\n};\n"]},"metadata":{},"sourceType":"script"}